<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Audit-Ready Finance</title>
<style>
  :root {
    --bg: #0f0f14;
    --surface: #1a1a24;
    --surface-2: #222233;
    --border: #2d2d44;
    --text: #e4e4ef;
    --text-dim: #8888aa;
    --purple: #7c3aed;
    --purple-dim: #5b21b6;
    --green: #22c55e;
    --amber: #f59e0b;
    --red: #ef4444;
    --cyan: #06b6d4;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  html, body { height: 100%; overflow: hidden; }
  body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    background: var(--surface);
    color: var(--text);
    display: flex; flex-direction: column;
  }

  /* Top Bar */
  .topbar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 24px;
    background: var(--surface);
    border-bottom: 1px solid var(--border);
  }
  .topbar h1 { font-size: 18px; font-weight: 600; color: var(--purple); }
  .topbar .controls { display: flex; gap: 12px; align-items: center; }
  .topbar select {
    background: var(--surface-2); color: var(--text); border: 1px solid var(--border);
    padding: 6px 12px; border-radius: 6px; font-size: 13px;
  }
  .topbar .status { font-size: 12px; color: var(--text-dim); }
  .topbar .status .dot {
    display: inline-block; width: 8px; height: 8px; border-radius: 50%;
    background: var(--green); margin-right: 4px;
  }

  /* Main Layout */
  .main {
    display: grid; grid-template-columns: 1fr 420px; gap: 0;
    flex: 1; min-height: 0;
  }
  .app-wrapper {
    display: flex; flex-direction: column; flex: 1; min-height: 0;
  }

  /* Left Panel */
  .left-panel { padding: 20px 24px; overflow-y: auto; border-right: 1px solid var(--border); }

  /* Query Input */
  .query-box { display: flex; gap: 8px; margin-bottom: 16px; }
  .query-box input {
    flex: 1; background: var(--surface); border: 1px solid var(--border); color: var(--text);
    padding: 10px 14px; border-radius: 8px; font-size: 14px; outline: none; transition: border-color 0.2s;
  }
  .query-box input:focus { border-color: var(--purple); }
  .query-box button {
    background: var(--purple); color: white; border: none; padding: 10px 20px;
    border-radius: 8px; font-size: 14px; font-weight: 500; cursor: pointer; transition: background 0.2s;
  }
  .query-box button:hover { background: var(--purple-dim); }
  .query-box button:disabled { opacity: 0.5; cursor: not-allowed; }

  /* Example Chips */
  .chips { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 20px; }
  .chip {
    background: var(--surface); border: 1px solid var(--border); color: var(--text-dim);
    padding: 6px 12px; border-radius: 20px; font-size: 12px; cursor: pointer; transition: all 0.2s;
  }
  .chip:hover { border-color: var(--purple); color: var(--text); }

  /* Answer Area */
  .answer-section { display: none; }
  .answer-section.visible { display: block; }
  .answer-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
  .answer-header h3 { font-size: 14px; font-weight: 600; color: var(--purple); }
  .answer-meta { font-size: 11px; color: var(--text-dim); }
  .answer-text {
    background: var(--surface); border: 1px solid var(--border); border-radius: 8px;
    padding: 16px; font-size: 14px; line-height: 1.6; margin-bottom: 16px; white-space: pre-wrap;
  }
  .citation-ref {
    background: var(--purple-dim); color: white; padding: 1px 6px; border-radius: 4px;
    font-size: 11px; font-weight: 600; cursor: pointer; text-decoration: none;
  }
  .citation-ref:hover { background: var(--purple); }

  /* Evidence Section */
  .evidence-section h4 {
    font-size: 13px; font-weight: 600; color: var(--text-dim); margin-bottom: 10px;
    text-transform: uppercase; letter-spacing: 0.5px;
  }
  .evidence-card {
    background: var(--surface); border: 1px solid var(--border); border-left: 3px solid var(--purple);
    border-radius: 0 8px 8px 0; padding: 12px 14px; margin-bottom: 8px; font-size: 13px;
  }
  .evidence-card .source { font-size: 11px; color: var(--text-dim); margin-top: 6px; }
  .evidence-card .cited { color: var(--cyan); font-style: italic; }

  /* Right Panel */
  .right-panel { padding: 20px; overflow-y: auto; background: var(--surface); }
  .right-panel h3 { font-size: 14px; font-weight: 600; color: var(--purple); margin-bottom: 16px; }

  /* Pipeline Steps */
  .pipeline-steps { display: flex; flex-direction: column; gap: 0; margin-left: 4px; }
  .pipe-step {
    display: flex; gap: 14px; padding: 0 10px; position: relative; min-height: 48px;
  }
  /* Vertical line on the left, connecting circles */
  .pipe-track {
    display: flex; flex-direction: column; align-items: center; flex-shrink: 0; width: 28px;
  }
  .pipe-line-top { width: 2px; height: 8px; background: transparent; }
  .pipe-step:not(:first-child) .pipe-line-top { background: var(--border); }
  .pipe-step:not(:first-child).done .pipe-line-top { background: var(--green); }
  .pipe-step:not(:first-child).running .pipe-line-top { background: var(--purple); }
  .pipe-line-bottom { width: 2px; flex: 1; background: transparent; }
  .pipe-step:not(:last-child) .pipe-line-bottom { background: var(--border); }
  .pipe-step:not(:last-child).done .pipe-line-bottom { background: var(--green); }
  .pipe-step:not(:last-child).running .pipe-line-bottom { background: var(--purple); }

  .pipe-icon {
    width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center;
    justify-content: center; font-size: 12px; font-weight: 700; flex-shrink: 0;
    border: 2px solid var(--border); color: var(--text-dim); background: var(--bg);
    transition: all 0.3s; z-index: 1;
  }
  .pipe-step.pending .pipe-icon { border-color: var(--border); color: var(--text-dim); }
  .pipe-step.running .pipe-icon { border-color: var(--purple); color: var(--purple); animation: pulse 1.5s ease-in-out infinite; }
  .pipe-step.done .pipe-icon { border-color: var(--green); color: var(--green); background: rgba(34,197,94,0.1); }
  @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.5; } }

  .pipe-body { flex: 1; min-width: 0; padding: 4px 0 12px; }
  .pipe-title { font-size: 13px; font-weight: 600; }
  .pipe-step.pending .pipe-title { color: var(--text-dim); }
  .pipe-step.running .pipe-title { color: var(--text); }
  .pipe-step.done .pipe-title { color: var(--text); }
  .pipe-detail {
    font-size: 12px; color: var(--text-dim); margin-top: 3px; line-height: 1.4;
  }
  .pipe-step.running .pipe-detail { color: var(--purple); }

  /* Thinking sub-messages */
  .pipe-thinking {
    margin-top: 6px; padding: 8px 10px; background: var(--bg); border-radius: 6px;
    border-left: 2px solid var(--purple-dim); font-size: 11px; color: var(--text-dim);
    line-height: 1.5; max-height: 120px; overflow-y: auto;
  }
  .pipe-thinking .think-line {
    padding: 2px 0; opacity: 0; animation: fadeIn 0.3s forwards;
  }
  .pipe-thinking .think-line .think-label {
    color: var(--purple); font-weight: 600; margin-right: 4px;
  }
  @keyframes fadeIn { to { opacity: 1; } }

  /* Graph + Provenance (shown after done) */
  .graph-section { margin-top: 16px; }
  .graph-section h4 { font-size: 13px; font-weight: 600; color: var(--cyan); margin-bottom: 8px; }
  .graph-entity {
    background: var(--bg); border: 1px solid var(--border); border-radius: 6px;
    padding: 8px 10px; margin-bottom: 6px; font-size: 12px; line-height: 1.5;
    white-space: pre-wrap; word-break: break-word; max-height: 120px; overflow-y: auto;
  }
  .graph-entity .entity-label { color: var(--cyan); font-weight: 600; font-size: 11px; text-transform: uppercase; margin-bottom: 4px; }

  .provenance-section { margin-top: 16px; }
  .provenance-section h4 { font-size: 13px; font-weight: 600; color: var(--text-dim); margin-bottom: 8px; }
  .provenance-path {
    font-size: 12px; color: var(--text-dim); padding: 10px; background: var(--bg);
    border-radius: 8px; border: 1px solid var(--border);
  }
  .provenance-arrow { color: var(--purple); margin: 4px 0; font-weight: 600; }

  .stats-bar {
    display: flex; gap: 16px; margin-top: 16px; padding: 10px; background: var(--bg);
    border-radius: 8px; font-size: 12px; border: 1px solid var(--border);
  }
  .stat { display: flex; flex-direction: column; align-items: center; }
  .stat .val { font-size: 15px; font-weight: 600; color: var(--purple); }
  .stat .label { color: var(--text-dim); font-size: 10px; text-transform: uppercase; }

  /* Bottom: Audit Log */
  .bottom-panel {
    border-top: 1px solid var(--border); background: var(--surface);
    flex-shrink: 0;
  }
  .bottom-panel.collapsed .bottom-content { display: none; }
  .bottom-header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 10px 24px; cursor: pointer; user-select: none;
  }
  .bottom-header:hover { background: var(--surface-2); }
  .bottom-header h3 { font-size: 14px; font-weight: 600; color: var(--text-dim); margin: 0; }
  .bottom-toggle {
    font-size: 16px; color: var(--text-dim); transition: transform 0.3s;
  }
  .bottom-panel.collapsed .bottom-toggle { transform: rotate(180deg); }
  .bottom-content { padding: 0 24px 8px; max-height: 220px; overflow-y: auto; }
  .audit-table { width: 100%; border-collapse: collapse; font-size: 12px; }
  .audit-table th {
    text-align: left; padding: 8px 12px; border-bottom: 1px solid var(--border);
    color: var(--text-dim); font-weight: 500; text-transform: uppercase; font-size: 10px; letter-spacing: 0.5px;
  }
  .audit-table td { padding: 8px 12px; border-bottom: 1px solid var(--border); }
  .audit-table tr { cursor: pointer; transition: background 0.15s; }
  .audit-table tr:hover { background: var(--surface-2); }
  .audit-table .query-col { max-width: 400px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .badge { display: inline-block; padding: 2px 8px; border-radius: 10px; font-size: 10px; font-weight: 600; }
  .badge.purple { background: var(--purple-dim); color: white; }
  .badge.green { background: #166534; color: var(--green); }

  .empty-state { text-align: center; padding: 40px; color: var(--text-dim); font-size: 13px; }

  .right-empty {
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    height: 100%; color: var(--text-dim); font-size: 13px; text-align: center; padding: 40px;
  }
  .right-empty .icon { font-size: 32px; margin-bottom: 12px; opacity: 0.3; }
</style>
</head>
<body>

<div class="topbar">
  <h1>Audit-Ready Finance</h1>
  <div class="controls">
    <select id="companyFilter">
      <option value="">All Companies</option>
      <option value="AAPL">Apple (AAPL)</option>
      <option value="TSLA">Tesla (TSLA)</option>
      <option value="JPM">JPMorgan (JPM)</option>
    </select>
    <select id="tenantFilter">
      <option value="">All Tenants</option>
      <option value="portfolio_team_a">Portfolio Team A</option>
      <option value="portfolio_team_b">Portfolio Team B</option>
    </select>
    <span class="status"><span class="dot"></span>Connected</span>
  </div>
</div>

<div class="app-wrapper">
<div class="main">
  <!-- Left Panel -->
  <div class="left-panel">
    <div class="query-box">
      <input type="text" id="queryInput" placeholder="Ask a question about SEC 10-K filings..." />
      <button id="askBtn" onclick="submitQuery()">Ask</button>
    </div>

    <div class="chips">
      <span class="chip" onclick="askExample(this)">Why does Apple have a lower risk profile than Tesla?</span>
      <span class="chip" onclick="askExample(this)">What drove Tesla's risk flag on supply chain?</span>
      <span class="chip" onclick="askExample(this)">Compare revenue growth strategies across all three companies</span>
      <span class="chip" onclick="askExample(this)">What are JPMorgan's key regulatory risk factors?</span>
      <span class="chip" onclick="askExample(this)">Show me the evidence for Apple's cash position strength</span>
    </div>

    <div class="answer-section" id="answerSection">
      <div class="answer-header">
        <h3>Answer</h3>
        <span class="answer-meta" id="answerMeta"></span>
      </div>
      <div class="answer-text" id="answerText"></div>

      <div class="evidence-section">
        <h4>Evidence &amp; Citations</h4>
        <div id="evidenceList"></div>
      </div>
    </div>
  </div>

  <!-- Right Panel -->
  <div class="right-panel" id="rightPanel">
    <div class="right-empty" id="rightEmpty">
      <div class="icon">&#9776;</div>
      <div>Ask a question to see the<br>retrieval pipeline in action</div>
    </div>
    <div id="auditTrail" style="display:none;">
      <h3>Pipeline</h3>
      <div class="pipeline-steps" id="pipelineSteps">
        <div class="pipe-step pending" id="pipe-1">
          <div class="pipe-track"><div class="pipe-line-top"></div><div class="pipe-icon">1</div><div class="pipe-line-bottom"></div></div>
          <div class="pipe-body">
            <div class="pipe-title">Build retrieval plan</div>
            <div class="pipe-detail">Waiting...</div>
            <div class="pipe-thinking" id="think-1" style="display:none;"></div>
          </div>
        </div>
        <div class="pipe-step pending" id="pipe-2">
          <div class="pipe-track"><div class="pipe-line-top"></div><div class="pipe-icon">2</div><div class="pipe-line-bottom"></div></div>
          <div class="pipe-body">
            <div class="pipe-title">Search knowledge graph</div>
            <div class="pipe-detail">Waiting...</div>
            <div class="pipe-thinking" id="think-2" style="display:none;"></div>
          </div>
        </div>
        <div class="pipe-step pending" id="pipe-3">
          <div class="pipe-track"><div class="pipe-line-top"></div><div class="pipe-icon">3</div><div class="pipe-line-bottom"></div></div>
          <div class="pipe-body">
            <div class="pipe-title">Search vector database</div>
            <div class="pipe-detail">Waiting...</div>
            <div class="pipe-thinking" id="think-3" style="display:none;"></div>
          </div>
        </div>
        <div class="pipe-step pending" id="pipe-4">
          <div class="pipe-track"><div class="pipe-line-top"></div><div class="pipe-icon">4</div><div class="pipe-line-bottom"></div></div>
          <div class="pipe-body">
            <div class="pipe-title">Generate answer</div>
            <div class="pipe-detail">Waiting...</div>
            <div class="pipe-thinking" id="think-4" style="display:none;"></div>
          </div>
        </div>
      </div>
      <div id="statsBar" class="stats-bar" style="display:none;"></div>
      <div class="graph-section" id="graphSection" style="display:none;">
        <h4>Graph Entities (Cognee)</h4>
        <div id="graphEntities"></div>
      </div>
      <div class="provenance-section" id="provenanceSection" style="display:none;">
        <h4>Provenance Path</h4>
        <div class="provenance-path" id="provenancePath"></div>
      </div>
    </div>
  </div>
</div>

<!-- Bottom Panel: Audit Log -->
<div class="bottom-panel collapsed" id="bottomPanel">
  <div class="bottom-header" onclick="toggleAuditLog()">
    <h3>Audit Log</h3>
    <span class="bottom-toggle">&#9660;</span>
  </div>
  <div class="bottom-content">
    <table class="audit-table" id="auditTable">
      <thead>
        <tr>
          <th>ID</th>
          <th>Timestamp</th>
          <th>Query</th>
          <th>Citations</th>
          <th>Tokens</th>
        </tr>
      </thead>
      <tbody id="auditBody">
        <tr><td colspan="5" class="empty-state">No queries yet. Ask a question to get started.</td></tr>
      </tbody>
    </table>
  </div>
</div>
</div>

<script>
const API = '';
let currentResult = null;

function toggleAuditLog() {
  document.getElementById('bottomPanel').classList.toggle('collapsed');
}

function resetPipeline() {
  for (let i = 1; i <= 4; i++) {
    const el = document.getElementById('pipe-' + i);
    el.className = 'pipe-step pending';
    el.querySelector('.pipe-detail').textContent = 'Waiting...';
    const think = document.getElementById('think-' + i);
    if (think) { think.innerHTML = ''; think.style.display = 'none'; }
  }
  document.getElementById('statsBar').style.display = 'none';
  document.getElementById('graphSection').style.display = 'none';
  document.getElementById('provenanceSection').style.display = 'none';
}

function updateStep(stage, status, title, detail) {
  const el = document.getElementById('pipe-' + stage);
  if (!el) return;
  el.className = 'pipe-step ' + status;
  if (title) el.querySelector('.pipe-title').textContent = title;
  if (detail) el.querySelector('.pipe-detail').textContent = detail;
  el.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

function addThinking(stage, text) {
  const think = document.getElementById('think-' + stage);
  if (!think) return;
  think.style.display = 'block';
  const line = document.createElement('div');
  line.className = 'think-line';
  line.innerHTML = '<span class="think-label">&gt;</span>' + escapeHtml(text);
  think.appendChild(line);
  think.scrollTop = think.scrollHeight;
}

async function submitQuery() {
  const input = document.getElementById('queryInput');
  const question = input.value.trim();
  if (!question) return;

  const btn = document.getElementById('askBtn');
  btn.disabled = true;

  // Reset UI
  document.getElementById('answerSection').classList.remove('visible');
  document.getElementById('rightEmpty').style.display = 'none';
  document.getElementById('auditTrail').style.display = 'block';
  resetPipeline();

  const tenant = document.getElementById('tenantFilter').value || null;
  const company = document.getElementById('companyFilter').value || null;

  let questionForApi = question;
  if (company) {
    const names = {AAPL: 'Apple', TSLA: 'Tesla', JPM: 'JPMorgan'};
    const name = names[company] || company;
    if (!question.toLowerCase().includes(name.toLowerCase())) {
      questionForApi = '[Focus on ' + name + '] ' + question;
    }
  }

  try {
    const resp = await fetch(API + '/api/query-stream', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ question: questionForApi, tenant_id: tenant, top_k: 8 }),
    });

    if (!resp.ok) {
      const errText = await resp.text();
      throw new Error('API error ' + resp.status + ': ' + errText.substring(0, 200));
    }

    const reader = resp.body.getReader();
    const decoder = new TextDecoder();
    let buffer = '';
    let eventType = null;

    while (true) {
      const { done, value } = await reader.read();
      if (done) break;

      buffer += decoder.decode(value, { stream: true });
      const lines = buffer.split('\n');
      buffer = lines.pop(); // keep incomplete line in buffer

      for (const line of lines) {
        if (line.startsWith('event: ')) {
          eventType = line.slice(7).trim();
        } else if (line.startsWith('data: ') && eventType) {
          const data = JSON.parse(line.slice(6));
          if (eventType === 'step') {
            updateStep(data.stage, data.status, data.title, data.detail);
          } else if (eventType === 'thinking') {
            addThinking(data.stage, data.text);
          } else if (eventType === 'result') {
            currentResult = data;
            renderAnswer(data);
            renderPostPipeline(data);
            loadAuditLog();
          }
          eventType = null;
        }
      }
    }
  } catch (err) {
    document.getElementById('answerText').textContent = 'Error: ' + err.message;
    document.getElementById('answerSection').classList.add('visible');
  } finally {
    btn.disabled = false;
  }
}

function askExample(chip) {
  document.getElementById('queryInput').value = chip.textContent;
  submitQuery();
}

function simpleMarkdown(text) {
  let html = escapeHtml(text);
  html = html.replace(/^### (.+)$/gm, '<h5 style="margin:12px 0 4px;color:var(--text);">$1</h5>');
  html = html.replace(/^## (.+)$/gm, '<h4 style="margin:14px 0 6px;color:var(--text);">$1</h4>');
  html = html.replace(/^# (.+)$/gm, '<h3 style="margin:16px 0 8px;color:var(--purple);">$1</h3>');
  html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
  html = html.replace(/\n/g, '<br>');
  html = html.replace(/\[(\d+)\]/g, '<span class="citation-ref">[$1]</span>');
  return html;
}

function renderAnswer(data) {
  document.getElementById('answerText').innerHTML = simpleMarkdown(data.answer || '');
  const nCites = (data.citations || []).length;
  const tokens = (data.tokens?.input || 0) + (data.tokens?.output || 0);
  document.getElementById('answerMeta').textContent = nCites + ' citations | ' + tokens + ' tokens';

  const evidenceList = document.getElementById('evidenceList');
  evidenceList.innerHTML = '';

  if (data.citations && data.citations.length > 0) {
    data.citations.forEach((cite, idx) => {
      const card = document.createElement('div');
      card.className = 'evidence-card';
      card.innerHTML =
        '<span class="badge purple">[' + (cite.index || idx + 1) + ']</span> ' +
        '<span class="cited">"' + escapeHtml((cite.cited_text || '').substring(0, 200)) + ((cite.cited_text || '').length > 200 ? '...' : '') + '"</span>' +
        '<div class="source">' + (cite.source_company || cite.document_title || 'Unknown') + ' | ' + (cite.source_section || '') + ' | FY' + (cite.source_fiscal_year || '?') + '</div>';
      evidenceList.appendChild(card);
    });
  } else {
    evidenceList.innerHTML = '<div class="empty-state">No structured citations extracted</div>';
  }

  document.getElementById('answerSection').classList.add('visible');
}

function renderPostPipeline(data) {
  // Stats
  const nCites = (data.citations || []).length;
  const nDocs = (data.vector_results || []).length;
  const nGraph = (data.graph_entities || []).length;
  const statsBar = document.getElementById('statsBar');
  statsBar.innerHTML =
    '<div class="stat"><div class="val">' + nDocs + '</div><div class="label">Documents</div></div>' +
    '<div class="stat"><div class="val">' + nGraph + '</div><div class="label">Entities</div></div>' +
    '<div class="stat"><div class="val">' + nCites + '</div><div class="label">Citations</div></div>' +
    '<div class="stat"><div class="val">' + ((data.tokens?.input || 0) + (data.tokens?.output || 0)) + '</div><div class="label">Tokens</div></div>';
  statsBar.style.display = 'flex';

  // Graph entities
  const graphEntities = data.graph_entities || [];
  const graphSection = document.getElementById('graphSection');
  const graphDiv = document.getElementById('graphEntities');
  if (graphEntities.length > 0 && !graphEntities[0]?.error) {
    graphSection.style.display = 'block';
    graphDiv.innerHTML = '';
    graphEntities.forEach(entity => {
      const card = document.createElement('div');
      card.className = 'graph-entity';
      if (entity.subject && entity.predicate) {
        card.innerHTML = '<div class="entity-label">Relationship</div>' + escapeHtml(entity.subject) + ' <strong style="color:var(--purple)">' + escapeHtml(entity.predicate) + '</strong> ' + escapeHtml(entity.object || '');
      } else if (entity.raw) {
        card.innerHTML = '<div class="entity-label">Graph Completion</div>' + escapeHtml(entity.raw);
      } else {
        card.textContent = JSON.stringify(entity, null, 2);
      }
      graphDiv.appendChild(card);
    });
  } else {
    graphSection.style.display = 'none';
  }

  // Provenance
  const prov = data.provenance_path || {};
  const provDiv = document.getElementById('provenancePath');
  let provHtml = '<strong>Query:</strong> ' + escapeHtml(prov.query || '') + '<br>';
  provHtml += '<div class="provenance-arrow">&#8595;</div>';
  provHtml += '<strong>Plan:</strong> ' + (prov.plan?.companies || []).join(', ') + ' | ' + (prov.plan?.sections || []).join(', ') + '<br>';
  provHtml += '<div class="provenance-arrow">&#8595;</div>';

  const vecDocs = prov.vector_documents || [];
  provHtml += '<strong>Documents:</strong> ' + vecDocs.length + ' chunks retrieved<br>';
  if (vecDocs.length > 0) {
    provHtml += '<div style="margin-left: 12px; margin-top: 4px;">';
    vecDocs.slice(0, 5).forEach(d => {
      provHtml += '<div>' + (d.company || '') + ' | ' + (d.section || '') + ' | score: ' + (d.score?.toFixed(3) || '?') + '</div>';
    });
    if (vecDocs.length > 5) provHtml += '<div>... and ' + (vecDocs.length - 5) + ' more</div>';
    provHtml += '</div>';
  }
  provHtml += '<div class="provenance-arrow">&#8595;</div>';
  provHtml += '<strong>Answer:</strong> ' + (prov.citation_count || 0) + ' citations generated';
  provDiv.innerHTML = provHtml;
  document.getElementById('provenanceSection').style.display = 'block';
}

async function loadAuditLog() {
  try {
    const resp = await fetch(API + '/api/audit-log?limit=20');
    const logs = await resp.json();
    const tbody = document.getElementById('auditBody');
    if (!logs || logs.length === 0) {
      tbody.innerHTML = '<tr><td colspan="5" class="empty-state">No queries yet</td></tr>';
      return;
    }
    tbody.innerHTML = logs.map(log =>
      '<tr onclick="loadAuditEntry(' + log.id + ')">' +
      '<td><span class="badge green">#' + log.id + '</span></td>' +
      '<td>' + new Date(log.timestamp).toLocaleTimeString() + '</td>' +
      '<td class="query-col">' + escapeHtml(log.query) + '</td>' +
      '<td>' + (log.citations_count || 0) + '</td>' +
      '<td>' + ((log.input_tokens || 0) + (log.output_tokens || 0)) + '</td>' +
      '</tr>'
    ).join('');
  } catch (err) {
    console.error('Failed to load audit log:', err);
  }
}

async function loadAuditEntry(id) {
  try {
    const resp = await fetch(API + '/api/audit-log/' + id);
    const data = await resp.json();

    const displayData = {
      answer: data.answer,
      citations: data.citations,
      citation_mode: data.model_used ? 'audit replay (' + data.model_used + ')' : 'audit replay',
      retrieval_plan: data.retrieval_plan,
      graph_entities: data.graph_entities,
      vector_results: (data.vector_results || []).map(v => ({
        company: v.company, section: v.section, score: v.score, text_preview: v.text_preview || '',
      })),
      provenance_path: data.provenance_path,
      tokens: { input: data.input_tokens, output: data.output_tokens },
    };

    document.getElementById('queryInput').value = data.query;
    document.getElementById('rightEmpty').style.display = 'none';
    document.getElementById('auditTrail').style.display = 'block';

    // Mark all steps as done for replays
    const steps = data.retrieval_plan?.steps || [];
    steps.forEach(s => {
      let detail = s.description || '';
      if (s.result_count !== undefined) detail += ' (' + s.result_count + ' results)';
      if (s.citation_count !== undefined) detail += ' (' + s.citation_count + ' citations)';
      updateStep(s.stage, 'done', s.action, detail);
    });

    renderAnswer(displayData);
    renderPostPipeline(displayData);
  } catch (err) {
    console.error('Failed to load audit entry:', err);
  }
}

function escapeHtml(str) {
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

document.getElementById('queryInput').addEventListener('keydown', e => {
  if (e.key === 'Enter') submitQuery();
});

loadAuditLog();
</script>
</body>
</html>
